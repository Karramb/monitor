{% extends 'base.html' %}

{% block title %}Создать задачу{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Создать новую задачу</h2>
  <form id="noteForm">
    <div class="mb-3">
      <label for="theme" class="form-label">Тема</label>
      <input type="text" class="form-control" id="theme" required>
    </div>
    <div class="mb-3">
      <label for="text" class="form-label">Текст</label>
      <textarea class="form-control" id="text" rows="5" required></textarea>
    </div>

    <div class="mb-3">
      <label for="group" class="form-label">Группа</label>
      <select id="group" class="form-select" required></select>
    </div>

    <div class="mb-3">
      <label for="tags" class="form-label">Тэги</label>
      <select id="tags" class="form-select" multiple></select>
    </div>

    <button type="submit" class="btn btn-primary">Создать</button>
  </form>
  <div id="message" class="mt-3"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('JS загружен и работает');

  // Получение CSRF токена из куки (Django требует для POST)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');
  axios.defaults.headers.common['X-CSRFToken'] = csrftoken;

  const groupSelect = document.getElementById('group');
  const tagsSelect = document.getElementById('tags');
  const form = document.getElementById('noteForm');
  const messageDiv = document.getElementById('message');

  // Загрузка групп из API
  function loadGroups() {
    axios.get('/notes/groups/')
      .then(response => {
        console.log('Группы:', response.data);
        groupSelect.innerHTML = '';
        response.data.forEach(group => {
          const option = document.createElement('option');
          option.value = group.id;
          option.textContent = group.name;
          groupSelect.appendChild(option);
        });
      })
      .catch(() => messageDiv.textContent = 'Ошибка загрузки групп');
  }

  // Загрузка тегов из API
  function loadTags() {
    axios.get('/notes/tags/')
      .then(response => {
        console.log('Теги:', response.data);
        tagsSelect.innerHTML = '';
        response.data.forEach(tag => {
          const option = document.createElement('option');
          option.value = tag.id;
          option.textContent = tag.name;
          tagsSelect.appendChild(option);
        });
      })
      .catch(() => messageDiv.textContent = 'Ошибка загрузки тегов');
  }

  loadGroups();
  loadTags();

  form.addEventListener('submit', e => {
    e.preventDefault();
    console.log('Форма отправлена');

    const selectedTags = Array.from(tagsSelect.selectedOptions).map(o => o.value);

    const payload = {
      theme: document.getElementById('theme').value,
      text: document.getElementById('text').value,
      groups: groupSelect.value,
      tags: selectedTags,
      // автор будет автоматически устанавливаться на сервере
    };

    console.log('Отправляем:', payload);

    axios.post('/notes/notes/', payload)
      .then(() => {
        messageDiv.innerHTML = '<div class="alert alert-success">Заметка создана!</div>';
        form.reset();
      })
      .catch(error => {
        let msg = 'Ошибка при создании заметки.';
        if (error.response && error.response.data) {
          msg += '<br>' + JSON.stringify(error.response.data);
        }
        messageDiv.innerHTML = `<div class="alert alert-danger">${msg}</div>`;
        console.error(error);
      });
  });
});
</script>
{% endblock %}
