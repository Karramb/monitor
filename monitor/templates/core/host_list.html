{% extends "base.html" %}
{% load static %}

{% block title %}Список серверов{% endblock %}

{% block content %}
<div id="servers" class="row">
  {% for host in hosts %}
  <div class="col-md-6 col-lg-4 mb-4 server-card" id="host-{{ host.id }}" data-host-id="{{ host.id }}">
    <div class="card h-100">
      <!-- Заголовок сервера -->
      <div class="card-header text-center">
        <h5 class="card-title mb-0">{{ host.name }}</h5>
      </div>
      
      <!-- Блок с кнопками -->
      <div class="card-body py-2 text-center" style="position: relative;">
        <div class="btn-group">
          {% if host.button_change_base %}
          <button class="btn btn-sm btn-outline-primary toggle-btn" 
                  data-host-id="{{ host.id }}">
            Переключить базу
          </button>
          {% endif %}
          {% if host.button_dump_pg %}
          <button class="btn btn-sm btn-outline-success restore-btn" 
                  data-host-id="{{ host.id }}">
            Накатить дамп PG
          </button>
          {% endif %}
        </div>
      </div>
      
      <!-- Блок с информацией о MongoDB -->
      <div class="card-footer bg-transparent">
        <div class="config-status text-center p-2 rounded">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Загрузка...</span>
          </div>
          Проверка конфигурации...
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.server-card').forEach(function(card) {
    const hostId = card.dataset.hostId;
    const configStatusEl = card.querySelector('.config-status');
    const toggleBtn = card.querySelector('.toggle-btn');
    const restoreBtn = card.querySelector('.restore-btn');
    const socket = new WebSocket(`ws://${window.location.host}/ws/core/${hostId}/`);
    
    // Привязываем карточку к сокету для доступа в обработчиках
    socket.card = card;

    function showGlobalSpinner(message) {
      hideGlobalSpinner();
    
      const spinnerHtml = `
        <div class="global-spinner position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(255,255,255,0.8); z-index: 10;">
          <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
              <span class="visually-hidden">Загрузка...</span>
            </div>
            <div class="spinner-message mt-2">${message}</div>
          </div>
        </div>
      `;
    
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = spinnerHtml;
      const spinnerEl = tempDiv.firstElementChild;
    
      if (spinnerEl) {
        // Добавляем спиннер в саму карточку
        card.style.position = 'relative'; // нужно для absolute overlay
        card.appendChild(spinnerEl);
      }
    }
    
    function hideGlobalSpinner() {
      const spinner = card.querySelector('.global-spinner');
      if (spinner) spinner.remove();
    }

    function showAlert(type, message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} mt-2 p-2`;
      alertDiv.textContent = message;
      card.querySelector('.card-footer').appendChild(alertDiv);
      
      // Автоскрытие через 5 секунд
      setTimeout(() => alertDiv.remove(), 5000);
    }

    function updateConfigStatus(status) {
      configStatusEl.innerHTML = status;
      if (status.includes("тестовая")) {
        configStatusEl.className = "config-status text-center p-2 rounded bg-warning text-dark";
      } else if (status.includes("продакшн")) {
        configStatusEl.className = "config-status text-center p-2 rounded bg-success text-white";
      } else {
        configStatusEl.className = "config-status text-center p-2 rounded bg-secondary text-white";
      }
    }

    socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      console.log("WebSocket message:", data); 
      
      // Обработка начала операций
      if (data.action === 'toggle_started') {
        showGlobalSpinner('Переключение MongoDB...');
        return;
      }
      
      if (data.action === 'restore_started') {
        showGlobalSpinner('Восстановление дампа PG...');
        return;
      }
      
      // Обработка завершения операций
      if (data.action === 'toggle_completed') {
        hideGlobalSpinner();
        showAlert('success', 'База успешно переключена');
        return;
      }
      
      if (data.action === 'restore_completed') {
        hideGlobalSpinner();
        showAlert('success', 'Дам PG успешно восстановлен');
        return;
      }
      
      // Обработка ошибок
      if (data.action === 'toggle_failed') {
        hideGlobalSpinner();
        showAlert('danger', `Ошибка переключения: ${data.error}`);
        return;
      }
      
      if (data.action === 'restore_failed') {
        hideGlobalSpinner();
        showAlert('danger', `Ошибка восстановления: ${data.error}`);
        return;
      }
      
      // Обработка статуса конфигурации
      if (data.config_status) {
        updateConfigStatus(data.config_status);
      }
      
      // Обработка других ошибок
      if (data.error) {
        showAlert('danger', data.error);
      }
    };

    socket.onerror = function(event) {
      hideGlobalSpinner();
      showAlert('danger', 'Ошибка соединения');
      console.error("WebSocket error for host ID", hostId, event);
    };
    
    socket.onclose = function() {
      hideGlobalSpinner();
      if (toggleBtn) toggleBtn.disabled = false;
      if (restoreBtn) restoreBtn.disabled = false;
    };

    if (toggleBtn) {
      toggleBtn.addEventListener('click', function() {
        if (confirm("Вы уверены, что хотите переключить базу данных?\nЭто может привести к кратковременной недоступности сервиса.")) {
          toggleBtn.disabled = true;
          socket.send(JSON.stringify({action: 'toggle_mongo'}));
        }
      });
    }

    if (restoreBtn) {
      restoreBtn.addEventListener('click', function() {
        if (confirm("Вы уверены, что хотите накатить дамп PG?\nЭто приведет к перезаписи текущих данных в базе.")) {
          restoreBtn.disabled = true;
          socket.send(JSON.stringify({action: 'restore_backup'}));
        }
      });
    }
  });
});
</script>

<style>
.server-card .card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid rgba(0, 0, 0, 0.1);
  position: relative;
}

.server-card .card:hover {
  transform: translateY(-3px);
  box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
}

.server-card .card-header {
  background-color: #f8f9fa;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 0.75rem 1rem;
}

.server-card .card-body {
  padding: 0.75rem 1rem;
  min-height: 60px;
}

.server-card .card-footer {
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  padding: 0.75rem 1rem;
}

.config-status {
  font-weight: 500;
  transition: all 0.3s ease;
}

.toggle-btn, .restore-btn {
  transition: all 0.2s ease;
  min-width: 120px;
  margin: 0 3px;
}

.toggle-btn:hover, .restore-btn:hover {
  transform: scale(1.05);
}

.alert {
  font-size: 0.85rem;
  margin-bottom: 0;
}

.btn-group {
  display: inline-flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 5px;
}

.global-spinner {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.spinner-overlay {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.spinner-message {
  margin-top: 1rem;
  font-weight: 500;
  color: #333;
}
</style>
{% endblock %}