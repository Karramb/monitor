{% extends "base.html" %}
{% load static %}

{% block title %}Список серверов{% endblock %}

{% block content %}
<div id="servers" class="row">
  {% for host in hosts %}
  <div class="col-md-6 col-lg-4 mb-4 server-card" id="host-{{ host.id }}" data-host-id="{{ host.id }}">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">{{ host.name }}</h5>
        {% if host.button_change_base %}
        <button class="btn btn-sm btn-outline-primary toggle-btn" 
                data-host-id="{{ host.id }}">
          Переключить базу
        </button>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="config-status mb-3 p-2 rounded text-center">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Загрузка...</span>
          </div>
          Проверка конфигурации...
        </div>
        <div class="current-config small text-muted mb-2"></div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.server-card').forEach(function(card) {
    const hostId = card.dataset.hostId;
    const configStatusEl = card.querySelector('.config-status');
    const currentConfigEl = card.querySelector('.current-config');
    const toggleBtn = card.querySelector('.toggle-btn');
    const socket = new WebSocket(`ws://${window.location.host}/ws/core/${hostId}/`);

    socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      
      // Очищаем предыдущие состояния
      configStatusEl.innerHTML = '';
      currentConfigEl.textContent = '';

      // Обработка ошибок
      if (data.error) {
        configStatusEl.innerHTML = `<div class="alert alert-danger p-2 mb-0">${data.error}</div>`;
        return;
      }

      // Отображаем статус конфигурации
      if (data.config_status) {
        configStatusEl.textContent = data.config_status;
        
        if (data.config_status.includes("тестовая")) {
          configStatusEl.className = "config-status mb-3 p-2 rounded text-center bg-warning text-dark";
        } else if (data.config_status.includes("продакшн")) {
          configStatusEl.className = "config-status mb-3 p-2 rounded text-center bg-success text-white";
        } else {
          configStatusEl.className = "config-status mb-3 p-2 rounded text-center bg-secondary text-white";
        }
      }

      // Отображаем текущий конфиг
      if (data.current_config) {
        currentConfigEl.textContent = `Конфигурационный файл: ${data.current_config.split('/').pop()}`;
      }

      // Обработка результата переключения
      if (data.toggle_result) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info mt-2 p-2';
        alertDiv.textContent = `Результат: ${data.toggle_result}`;
        card.querySelector('.card-body').appendChild(alertDiv);
      }
    };

    socket.onerror = function(event) {
      configStatusEl.innerHTML = '<div class="alert alert-danger p-2 mb-0">Ошибка соединения</div>';
      console.error("WebSocket error for host ID", hostId, event);
    };
    
    toggleBtn.addEventListener('click', function() {
      if (confirm("Вы уверены, что хотите переключить базу данных?\nЭто может привести к кратковременной недоступности сервиса.")) {
        toggleBtn.disabled = true;
        toggleBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Переключение...';
        
        socket.send(JSON.stringify({action: 'toggle_mongo'}));
        
        // Восстановим кнопку через 5 секунд на случай ошибки
        setTimeout(() => {
          toggleBtn.disabled = false;
          toggleBtn.textContent = 'Переключить базу';
        }, 5000);
      }
    });
  });
});
</script>

<style>
.server-card .card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.server-card .card:hover {
  transform: translateY(-3px);
  box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
}

.config-status {
  font-weight: 500;
  transition: all 0.3s ease;
}

.current-config {
  font-family: monospace;
  font-size: 0.8rem;
  word-break: break-all;
}

.toggle-btn {
  transition: all 0.2s ease;
  min-width: 120px;
}

.toggle-btn:hover {
  transform: scale(1.05);
}

.alert {
  font-size: 0.85rem;
  margin-bottom: 0.5rem;
}
</style>
{% endblock %}